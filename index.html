<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Angel Adviser</title>
  <style>
    body { background-color: #d9ebf9; font-family: Arial, sans-serif; display: flex; flex-direction: column; align-items: center; padding: 20px; }
    h1 { color: #2266aa; }
    .container { display: flex; gap: 20px; margin-top: 20px; width: 90%; max-width: 1200px; }
    .left, .right { flex: 1; background: #fff; border-radius: 10px; padding: 20px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    .chatBox { min-height: 200px; margin-bottom: 20px; }
    .activePhase { background-color: #cce5ff; padding: 10px; border-radius: 5px; margin-bottom: 10px; font-weight: bold; }
    #progress { margin-bottom: 15px; font-size: 16px; font-weight: bold; color: #333; }
    textarea, input { width: 100%; margin-top: 10px; padding: 10px; border-radius: 5px; border: 1px solid #ccc; }
    button { margin: 5px; padding: 10px 20px; font-size: 16px; border: none; border-radius: 5px; cursor: pointer; }
    .yes { background-color: #4CAF50; color: white; }
    .no { background-color: #f44336; color: white; }
    .next { background-color: #ff9800; color: white; }
    .pdf { background-color: #007BFF; color: white; }
    .reset { background-color: #FFA500; color: white; }
    .gpt-response { margin-top: 10px; background: #e6f2ff; padding: 10px; border-radius: 5px; font-style: italic; }
  </style>
</head>
<body>

<h1>Angel Adviser</h1>
<div id="progress">Fortschritt: 0% abgeschlossen</div>

<div class="container">
  <div class="left">
    <div>
      <h3>Schuldnerdaten</h3>
      <input id="inputName" placeholder="Name des Schuldners">
      <input id="inputAdresse" placeholder="Adresse des Schuldners">
      <input id="inputUnternehmen" placeholder="Ihr Unternehmen">
      <input id="inputMandant" placeholder="Mandant">
      <input id="inputBetrag" placeholder="Betrag (‚Ç¨)">
      <input id="inputWunschrate" placeholder="Wunschrate (‚Ç¨)">
      <input id="inputFristtag" placeholder="Fristtag (Datum)">
      <button onclick="startConversation()" style="margin-top:10px; background:#4CAF50; color:white;">Gespr√§ch starten</button>
    </div>

    <div id="chat" class="chatBox" style="margin-top:20px;">Angel: Bitte f√ºllen Sie oben die Schuldnerdaten aus und starten Sie das Gespr√§ch.</div>
    <div id="gptHelp" class="gpt-response"></div>
    <textarea id="notes" placeholder="Hier Ihre Gespr√§chsnotizen eintragen..."></textarea>
    <br>
    <button id="btnYes" class="yes">Ja</button>
    <button id="btnNo" class="no">Nein</button>
    <button id="btnNext" class="next">Weiter</button>
    <button id="btnPDF" class="pdf">PDF speichern</button>
    <button id="btnRestart" class="reset">Neustart</button>
  </div>
  <div class="right">
    <h3>Gespr√§chsprotokoll</h3>
    <div id="phasesList"></div><div id="hintContainer"></div>    <!-- Hier kommen sp√§ter die Buttons rein -->
    <div id="hints"></div> 
    <div id="summary"></div>
  </div>
  
</div>

<script>
const apiKey = "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";

const ultraPhases = [
  {
    description: "Gespr√§chseinstieg & Orientierung",
    user: {
      role: "user",
      content: "Starte freundlich aber strukturiert:\n1. Begr√º√üung: 'Frau/Herr {{NAME_SCHULDNER}}, ich verstehe Ihre Zur√ºckhaltung total.'\n2. Anlass kl√§ren: 'Es geht nicht um ein Verkaufsgespr√§ch oder eine Umfrage.'\n3. Grund nennen: 'Ich habe eine R√ºckfrage zu einer Rechnung mit rechtlichem Bestand.'\nWenn Unsicherheit besteht: 'Wir pr√ºfen erst kurz Ihre Angaben, dann erkl√§re ich alles Weitere.' Danach direkt zum Adressabgleich √ºberleiten."
    },
    hints: {
      ziel: "Vertrauensbasis schaffen, Gespr√§chsbereitschaft sichern.",
      typischeEinw√§nde: ["Wer sind Sie?", "Worum geht es?", "Ich mache keine Umfragen."],
      verhaltenBeiJa: "Direkt zum Adressabgleich weiterleiten.",
      verhaltenBeiNein: "Kurz ruhig bleiben, sachlich die Notwendigkeit erkl√§ren, dann erneut versuchen."
    }
  },
  {
    description: "Adressabgleich",
    user: {
      role: "user",
      content: "Frage direkt und verbindlich:\n'Darf ich zur Sicherheit Ihre Adresse pr√ºfen? Stimmt: {{ADRESSE}}?'\nBei Ablehnung: 'Identit√§tspr√ºfung ist gesetzlich vorgeschrieben, ich darf ohne Best√§tigung nicht weitermachen.' Danach sofort zum n√§chsten Schritt √ºberleiten."
    },
    hints: {
      ziel: "Identit√§t sicherstellen, rechtlichen Rahmen schaffen.",
      typischeEinw√§nde: ["Warum brauchen Sie meine Adresse?", "Was passiert mit meinen Daten?"],
      verhaltenBeiJa: "Dankesch√∂n sagen und weitermachen.",
      verhaltenBeiNein: "Ruhig bleiben, Pflicht zur Identit√§tspr√ºfung erkl√§ren."
    }
  },
  {
    description: "Seri√∂se Meldung & rechtlicher Rahmen",
    user: {
      role: "user",
      content: "Klar und seri√∂s auftreten:\n'Ich melde mich aus dem Unternehmen {{UNTERNEHMEN}}, im Auftrag unseres Mandanten {{MANDANT}}.'\n'Es geht um eine offene Forderung in H√∂he von {{BETRAG}} Euro.'\n'K√∂nnen wir das noch au√üergerichtlich kl√§ren?'\nDanach ruhig warten ‚Äì keine Details diskutieren!"
    },
    hints: {
      ziel: "Forderung etablieren, au√üergerichtliche L√∂sung anbieten.",
      typischeEinw√§nde: ["Ich wei√ü von keiner Forderung.", "Ich habe schon bezahlt."],
      verhaltenBeiJa: "Direkt zur Zahlungsvereinbarung oder Sachverhaltskl√§rung √ºberleiten.",
      verhaltenBeiNein: "Sachverhaltskl√§rung einleiten, keine lange Diskussion."
    }
  },
  {
    description: "Sachverhaltskl√§rung (nur bei Bedarf)",
    user: {
      role: "user",
      content: "Nur wenn Schuldner widerspricht:\n'Wann genau haben Sie √ºberwiesen, Frau/Herr {{NAME_SCHULDNER}}?'\nBei Unsicherheit: 'Wie viel? An wen?'\nDann sofort erkl√§ren: 'Ich gehe davon aus, dass Sie bezahlt haben. Ich w√ºrde daher vorsorglich am {{FRISTTAG}} die Abbuchung ansto√üen.'"
    },
    hints: {
      ziel: "Zahlungsdokumentation kl√§ren, Zahlungsl√ºcke verstehen.",
      typischeEinw√§nde: ["Ich habe das schon l√§ngst √ºberwiesen.", "Das Konto war vielleicht falsch."],
      verhaltenBeiJa: "Kulant reagieren, aber Abbuchung vorschlagen.",
      verhaltenBeiNein: "Neutral bleiben, keine Schuldzuweisungen."
    }
  },
  {
    description: "Einwandbehandlung (nur bei expliziter Ablehnung)",
    user: {
      role: "user",
      content: "Nur aktivieren bei klarer Ablehnung:\n'Okay, dann gebe ich den Vorgang ans Amtsgericht weiter. Dort entstehen erhebliche Mehrkosten. Die Entscheidung liegt bei Ihnen.'\nDanach still bleiben, keine Diskussion."
    },
    hints: {
      ziel: "Druck aufbauen ohne aggressiv zu sein, Entscheidung beim Schuldner lassen.",
      typischeEinw√§nde: ["Dann lassen Sie es eben auf ein Gerichtsverfahren ankommen.", "Ich zahle sowieso nichts."],
      verhaltenBeiJa: "Wenn Einlenken: Weiter im Prozess.",
      verhaltenBeiNein: "Notieren und Gespr√§ch respektvoll beenden."
    }
  },
  {
    description: "Zahlungsvereinbarung & Ratenmodell",
    user: {
      role: "user",
      content: "Biete zuerst Vollzahlung {{BETRAG}} an.\nWenn n√∂tig, Ratenzahlung anbieten:\n1. Hinweis: 'Ratenzahlung ist eigentlich nicht vorgesehen.'\n2. Nachfrage: 'Was w√§re maximal monatlich m√∂glich?'\nHinweis auf √ºbliche Raten: '{{WUNSCHRATE}} - {{WUNSCHRATE_PLUS20}} Euro.'"
    },
    hints: {
      ziel: "Realistische Zahlungsvereinbarung erreichen.",
      typischeEinw√§nde: ["Ich kann nur ganz wenig zahlen.", "Ich brauche l√§nger Zeit."],
      verhaltenBeiJa: "Direkt alle Details (Summe, Rate, Termin) fixieren.",
      verhaltenBeiNein: "Versuchen, wenigstens eine kleine Rate zu vereinbaren."
    }
  },
  {
    description: "Zusammenfassung der Vereinbarung",
    user: {
      role: "user",
      content: "Alles verbindlich zusammenfassen:\n'Wir haben heute vereinbart: Zahlung von {{BETRAG}} Euro, monatlich {{RATE}} Euro, Zahlung sp√§testens bis {{ZAHLUNGSTERMIN}}.'"
    },
    hints: {
      ziel: "Verbindlichkeit schaffen, Missverst√§ndnisse verhindern.",
      typischeEinw√§nde: ["Ich habe das anders verstanden.", "Ich wei√ü nicht genau wann ich zahlen kann."],
      verhaltenBeiJa: "Freundlich best√§tigen, Gespr√§chsabschluss vorbereiten.",
      verhaltenBeiNein: "Ruhig Details erneut erkl√§ren."
    }
  },
  {
    description: "Gespr√§chsende",
    user: {
      role: "user",
      content: "Verbindlich abschlie√üen:\n'Vielen Dank f√ºr das Gespr√§ch. Ich z√§hle auf Ihre p√ºnktliche Zahlung.'\nKeine Floskeln, keine Unsicherheiten erzeugen!"
    },
    hints: {
      ziel: "Positiv, aber bestimmt abschlie√üen.",
      typischeEinw√§nde: ["Was wenn ich es nicht schaffe?", "Ich rufe nochmal an."],
      verhaltenBeiJa: "Best√§tigen und verabschieden.",
      verhaltenBeiNein: "Nicht erneut diskutieren, freundlich beenden."
    }
  }
];



let currentPhase = -1;
let completedPhases = 0;
let notes = [];
let userData = {};

function collectUserData() {
  userData = {
    NAME_SCHULDNER: document.getElementById('inputName').value || 'Schuldner',
    ADRESSE: document.getElementById('inputAdresse').value || 'Adresse',
    UNTERNEHMEN: document.getElementById('inputUnternehmen').value || 'Ihr Unternehmen',
    MANDANT: document.getElementById('inputMandant').value || 'Mandant',
    BETRAG: document.getElementById('inputBetrag').value || '0',
    WUNSCHRATE: document.getElementById('inputWunschrate').value || '0',
    WUNSCHRATE_PLUS20: (parseInt(document.getElementById('inputWunschrate').value || 0) + 20).toString(),
    FRISTTAG: document.getElementById('inputFristtag').value || 'Datum',
    RATE: document.getElementById('inputWunschrate').value || '0',
    ZAHLUNGSTERMIN: '5. des Monats'
  };
}

function renderPhaseList() {
  const listContainer = document.getElementById('phasesList');
  listContainer.innerHTML = ''; // Vorher alles l√∂schen

  ultraPhases.forEach((phase, index) => {
    const button = document.createElement('button');
    button.innerText = phase.description;
    button.style.display = 'block';
    button.style.marginBottom = '5px';
    button.style.padding = '10px';
    button.style.width = '100%';
    button.style.textAlign = 'left';
    button.style.borderRadius = '8px';
    button.style.border = (index === currentPhase) ? '2px solid #4CAF50' : '1px solid #ccc';
    button.style.backgroundColor = (index === currentPhase) ? '#e8f5e9' : '#f9f9f9';
    button.style.fontWeight = (index === currentPhase) ? 'bold' : 'normal';

    button.onclick = () => {
      currentPhase = index;
      loadPhase();
      callGPTforCurrentPhase();
      renderPhaseList(); // Damit aktuelle Phase farblich bleibt
      showHintForCurrentPhase();
    };

    listContainer.appendChild(button);
  });
}

function showHintForCurrentPhase() {
  const hintContainer = document.getElementById('hintContainer');
  const phase = ultraPhases[currentPhase];

  if (!hintContainer) {
    console.error('HintContainer fehlt!');
    return;
  }

  hintContainer.innerHTML = `
    <div style="margin-top:10px; padding:10px; border:1px solid #ccc; border-radius:8px;">
      <button onclick="toggleHints()" style="margin-bottom:10px;">Hinweise anzeigen/ausblenden</button>
      <div id="hintContent" style="display:none;">
        <strong>Ziel dieser Phase:</strong><br>
        ${phase.goal || "Kein Ziel definiert"}<br><br>
        <strong>Typische Ausreden:</strong><br>
        ${phase.excuses ? phase.excuses.join("<br>") : "Keine Beispiele vorhanden."}
      </div>
    </div>
  `;
}

function toggleHints() {
  const content = document.getElementById('hintContent');
  if (content) {
    if (content.style.display === 'none') {
      content.style.display = 'block';
    } else {
      content.style.display = 'none';
    }
  }
}




function callGPTforCurrentPhase() {
  const phase = ultraPhases[currentPhase];
  let userPrompt = phase.user.content;
  for (const key in userData) {
    userPrompt = userPrompt.replaceAll(`{{${key}}}`, userData[key]);
  }
  callGPT(userPrompt);
}

function startConversation() {
  collectUserData();
  currentPhase = 0;
  completedPhases = 0;
  notes = [];
  document.getElementById('summary').innerHTML = '';
  updateProgress();
  loadPhase();
  renderPhaseList(); // <<< HIER hinzuf√ºgen
}


function updateProgress() {
  const percent = ((completedPhases / ultraPhases.length) * 100).toFixed(0);
  document.getElementById('progress').innerText = `Fortschritt: ${percent}% abgeschlossen`;
}

function loadPhase() {
  if (currentPhase >= ultraPhases.length) {
    document.getElementById('chat').innerHTML = "<div class='activePhase'><strong>Gespr√§ch abgeschlossen!</strong></div>";
    document.getElementById('gptHelp').innerText = "Vielen Dank f√ºr das Gespr√§ch.";
    renderPhaseHints(); // <<< WICHTIG: leere Hinweise am Ende
    return;
  }
  
  const phase = ultraPhases[currentPhase];
  let userPrompt = phase.user.content;
  for (const key in userData) {
    userPrompt = userPrompt.replaceAll(`{{${key}}}`, userData[key]);
  }
  
  document.getElementById('chat').innerHTML = `<div class='activePhase'><strong>${phase.description}</strong></div>`;
  callGPT(userPrompt);
  renderPhaseHints(); // <<< HINWEISE ZUR AKTUELLEN PHASE ZEIGEN
}



function callGPTforCurrentPhase() {
  const phase = ultraPhases[currentPhase];
  let userPrompt = phase.user.content;
  for (const key in userData) {
    userPrompt = userPrompt.replaceAll(`{{${key}}}`, userData[key]);
  }
  callGPT(userPrompt);
}


async function callGPT(userPrompt) {
  document.getElementById('gptHelp').innerText = "Lade Formulierung...";
  try {
    const res = await fetch("https://api.openai.com/v1/chat/completions", {
      method: "POST",
      headers: { "Content-Type": "application/json", "Authorization": `Bearer ${apiKey}` },
      body: JSON.stringify({
        model: "gpt-4-turbo",
        messages: [
          {
            role: "system",
            content: "Du bist ein hochtrainierter Inkasso-Mitarbeiter, der strikt nach einem Schulungsleitfaden handelt. Deine Sprache ist leicht kollegial, aber sachlich-streng, zielgerichtet und effizient. Keine Floskeln. Keine offenen Fragen ohne ausdr√ºckliche Anweisung. Keine Wiederholungen. Nach Abschluss einer Phase darfst du nicht zur√ºckspringen. Du reagierst flexibel auf Schuldnerantworten, ohne die Gespr√§chsstruktur zu verlieren. Dein Ziel ist es, eine au√üergerichtliche Zahlung zu erreichen oder den gerichtlichen Weg vorzubereiten."
          },
          { role: "user", content: userPrompt }
        ]
      })
    });
    const data = await res.json();
    document.getElementById('gptHelp').innerText = data.choices?.[0]?.message.content || 'Keine Antwort erhalten.';
  } catch (error) {
    console.error(error);
    document.getElementById('gptHelp').innerText = 'Verbindungsfehler';
  }
}

function saveNote() {
  const text = document.getElementById('notes').value.trim();
  if (text) {
    if (!ultraPhases[currentPhase].notes) {
      ultraPhases[currentPhase].notes = [];
    }
    ultraPhases[currentPhase].notes.push(text);
  }
}


function nextPhase() {
  saveNote();            // Notiz speichern
  completedPhases++;     // Fortschritt erh√∂hen
  currentPhase++;        // n√§chste Phase

  if (currentPhase < ultraPhases.length) {
    loadPhase();         // neue Phase laden
    callGPTforCurrentPhase(); // neue GPT-Antwort holen
    renderPhaseList();   // Gespr√§chsprotokoll-Liste neu zeichnen
    updateProgress();    // Fortschritt updaten
  } else {
    document.getElementById('chat').innerHTML = "<strong>Gespr√§ch abgeschlossen!</strong>";
    document.getElementById('gptHelp').innerText = "Zusammenfassung gespeichert.";
    renderPhaseList(); // auch hier: Gespr√§chsprotokoll nochmal updaten
  }
}
function renderPhaseHints() {
  const hintsContainer = document.getElementById('hints');
  if (!hintsContainer) return;

  const phase = ultraPhases[currentPhase];
  if (!phase || !phase.hints) {
    hintsContainer.innerHTML = "";
    return;
  }

  const { ziel, typischeEinw√§nde, verhaltenBeiJa, verhaltenBeiNein } = phase.hints;

  hintsContainer.innerHTML = `
    <div style="background: #e8f4fc; padding: 15px; margin-top: 15px; border-radius: 10px; box-shadow: 0 0 5px rgba(0,0,0,0.1);">
      <h4>üîç Ziel dieser Phase:</h4>
      <p>${ziel}</p>

      <h4>üõë Typische Einw√§nde:</h4>
      <ul>${typischeEinw√§nde.map(einwand => `<li>${einwand}</li>`).join('')}</ul>

      <h4>‚úîÔ∏è Verhalten bei JA:</h4>
      <p>${verhaltenBeiJa}</p>

      <h4>‚ùå Verhalten bei NEIN:</h4>
      <p>${verhaltenBeiNein}</p>
    </div>
  `;
}


document.getElementById('btnYes').onclick = nextPhase;
document.getElementById('btnNo').onclick = nextPhase;
document.getElementById('btnNext').onclick = nextPhase;

document.getElementById('notes').addEventListener('keydown', function(event) {
  if (event.key === "Enter" && !event.shiftKey) { // Enter dr√ºcken (ohne Shift)
    event.preventDefault(); // Kein Zeilenumbruch
    saveNote();
    document.getElementById('notes').value = ''; // Eingabefeld leeren
    renderPhaseList(); // neu zeichnen, damit Notizen sichtbar sind
  }
});

document.getElementById('btnPDF').onclick = () => {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.text(document.getElementById('summary').innerText, 10, 10);
  doc.save('gespraechsprotokoll.pdf');
};
document.getElementById('btnRestart').onclick = startConversation;

document.getElementById('notes').addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault(); // verhindert Zeilenumbruch
    saveNote();         // nur Notiz speichern
    renderPhaseList();  // Notiz im Gespr√§chsprotokoll aktualisieren
  }
});
renderPhaseList();


</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</body>
</html>
